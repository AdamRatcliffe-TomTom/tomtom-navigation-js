From 2f63d1aed341b9118c1df14200dd074d8dff4e03 Mon Sep 17 00:00:00 2001
From: Adam Ratcliffe <adam.ratcliffe@tomtom.com>
Date: Mon, 11 Nov 2024 09:20:20 -0800
Subject: [PATCH 22/22] Numerous changes to resolve build issues and set
 default prop values.

---
 package.json                                  | 10 +++++----
 rollup.config.mjs                             |  9 +++++---
 src/app/App.js                                | 22 ++++++++++---------
 src/features/map/markers/MarkerFactory.js     |  1 +
 src/features/navigation/BottomPanel.js        |  1 +
 src/features/navigation/Navigation.js         |  5 ++++-
 .../navigation/NavigationGuidancePanel.js     | 12 +++++-----
 src/functions/getManeuverIcon.js              |  1 +
 src/functions/tomtom2mapbox.js                |  3 +++
 src/index.js                                  |  2 ++
 10 files changed, 43 insertions(+), 23 deletions(-)

diff --git a/package.json b/package.json
index 83ce8dc..3712956 100755
--- a/package.json
+++ b/package.json
@@ -4,10 +4,11 @@
   "description": "TomTom navigation component for Javascript.",
   "main": "dist/index.cjs.js",
   "module": "dist/index.esm.js",
-  "exports": {
-    "import": "./dist/index.esm.js",
-    "require": "./dist/index.cjs.js"
+  ".": {
+    "require": "./dist/index.cjs.js",
+    "import": "./dist/index.esm.js"
   },
+  "./style": "./dist/index.esm.css",
   "type": "module",
   "scripts": {
     "build": "rollup -c",
@@ -29,6 +30,7 @@
     "@turf/clean-coords": "^6.5.0",
     "@turf/helpers": "^6.5.0",
     "cheap-ruler": "^3.0.2",
+    "crypto-browserify": "^3.12.1",
     "date-fns": "^2.30.0",
     "lodash.isempty": "^4.4.0",
     "lodash.isnil": "^4.0.0",
@@ -54,6 +56,7 @@
     "@rollup/plugin-node-resolve": "^15.3.0",
     "postcss": "^8.4.47",
     "rollup": "^4.24.4",
+    "rollup-plugin-import-css": "^3.5.6",
     "rollup-plugin-peer-deps-external": "^2.2.4",
     "rollup-plugin-postcss": "^4.0.2",
     "rollup-plugin-terser": "^7.0.2"
@@ -67,7 +70,6 @@
     "react-dom": "^17.0.0"
   },
   "browser": {
-    "crypto": false,
     "worker_threads": false,
     "react-dom/server": false
   }
diff --git a/rollup.config.mjs b/rollup.config.mjs
index 57d53eb..00f3ec5 100644
--- a/rollup.config.mjs
+++ b/rollup.config.mjs
@@ -3,6 +3,7 @@ import resolve from "@rollup/plugin-node-resolve";
 import commonjs from "@rollup/plugin-commonjs";
 import postcss from "rollup-plugin-postcss";
 import json from "@rollup/plugin-json";
+import css from "rollup-plugin-import-css";
 import peerDepsExternal from "rollup-plugin-peer-deps-external";
 
 export default {
@@ -23,7 +24,8 @@ export default {
   plugins: [
     peerDepsExternal(),
     resolve({
-      extensions: [".js", ".jsx"]
+      extensions: [".js", ".jsx"],
+      preferBuiltins: false
     }),
     babel({
       exclude: "node_modules/**",
@@ -41,7 +43,8 @@ export default {
       extract: true, // This will extract the CSS to a separate file
       minimize: true // Optionally minimize the CSS
     }),
-    json()
+    json(),
+    css()
   ],
-  external: ["guidance-sim", "guidance-replay"]
+  external: ["guidance-sim", "guidance-replay", "crypto"]
 };
diff --git a/src/app/App.js b/src/app/App.js
index 0d694b2..6e4e971 100644
--- a/src/app/App.js
+++ b/src/app/App.js
@@ -32,24 +32,25 @@ function App({
   apiKey,
   theme = detectColorScheme(),
   language = "en-US",
-  measurementSystem,
+  measurementSystem = "auto",
   width,
   height,
   guidanceVoice,
   guidanceVoiceVolume,
-  simulationSpeed,
-  mapOptions,
+  simulationSpeed = "3x",
+  mapOptions = {},
   initialCenter,
   initialZoom,
   routeOptions = {},
   automaticRouteCalculation,
-  showBottomPanel,
-  showGuidancePanel,
-  showArrivalPanel,
-  onNavigationStarted,
-  onNavigationStopped,
-  onProgressUpdate,
-  onDestinationReached
+  guidancePanelYOffset = 0,
+  showBottomPanel = true,
+  showGuidancePanel = true,
+  showArrivalPanel = true,
+  onNavigationStarted = () => {},
+  onNavigationStopped = () => {},
+  onProgressUpdate = () => {},
+  onDestinationReached = () => {}
 }) {
   strings.setLanguage(language);
 
@@ -111,6 +112,7 @@ function App({
         <div className="TomTomNavigation">
           <Map {...mapOptions}>
             <Navigation
+              guidancePanelYOffset={guidancePanelYOffset}
               onNavigationStarted={onNavigationStarted}
               onNavigationStopped={onNavigationStopped}
               onProgressUpdate={onProgressUpdate}
diff --git a/src/features/map/markers/MarkerFactory.js b/src/features/map/markers/MarkerFactory.js
index 3db4edf..d0a1264 100644
--- a/src/features/map/markers/MarkerFactory.js
+++ b/src/features/map/markers/MarkerFactory.js
@@ -1,3 +1,4 @@
+import React from "react";
 import DefaultMarker from "./DefaultMarker";
 import ImageMarker from "./ImageMarker";
 import { v4 as uuid } from "uuid";
diff --git a/src/features/navigation/BottomPanel.js b/src/features/navigation/BottomPanel.js
index dd028c7..bb80ee2 100644
--- a/src/features/navigation/BottomPanel.js
+++ b/src/features/navigation/BottomPanel.js
@@ -1,3 +1,4 @@
+import React from "react";
 import { makeStyles } from "@fluentui/react";
 import { useSelector } from "react-redux";
 import ETAPanel from "./ETAPanel";
diff --git a/src/features/navigation/Navigation.js b/src/features/navigation/Navigation.js
index 9250d37..c729015 100644
--- a/src/features/navigation/Navigation.js
+++ b/src/features/navigation/Navigation.js
@@ -63,6 +63,7 @@ import {
 
 const Navigation = ({
   map,
+  guidancePanelYOffset,
   onNavigationStarted,
   onNavigationStopped,
   onProgressUpdate,
@@ -344,7 +345,9 @@ const Navigation = ({
 
   return (
     <>
-      {guidancePanelIsVisible && <NavigationGuidancePanel route={route} />}
+      {guidancePanelIsVisible && (
+        <NavigationGuidancePanel route={route} yOffset={guidancePanelYOffset} />
+      )}
       {bottomPanelIsVisible && (
         <BottomPanel
           route={route}
diff --git a/src/features/navigation/NavigationGuidancePanel.js b/src/features/navigation/NavigationGuidancePanel.js
index de0d427..a81dab7 100644
--- a/src/features/navigation/NavigationGuidancePanel.js
+++ b/src/features/navigation/NavigationGuidancePanel.js
@@ -28,12 +28,13 @@ const useStyles = ({
   isPhone,
   isTablet,
   landscapeMinimal,
-  countryCode
+  countryCode,
+  yOffset
 }) =>
   makeStyles((theme) => ({
     root: {
       position: "absolute",
-      top: 0,
+      top: yOffset,
       left: 0,
       margin: `${theme.spacing.m} ${theme.spacing.m} 0`,
       ...(isTablet && {
@@ -80,7 +81,7 @@ const useStyles = ({
 
 const styleId = "guidance-ctrl-margin-adjustment";
 
-const NavigationGuidancePanel = ({ route }) => {
+const NavigationGuidancePanel = ({ route, yOffset = 0 }) => {
   // Using offsetSize option to useMeasure is necessary to ignore the parent scale
   // transformation Power Apps will apply if "Scale to fit" is enabled
   const [guidancePanelRef, bounds] = useMeasure({ offsetSize: true });
@@ -97,7 +98,8 @@ const NavigationGuidancePanel = ({ route }) => {
     isPhone,
     isTablet,
     landscapeMinimal,
-    countryCode
+    countryCode,
+    yOffset
   })();
   const guidancePanelHeight = bounds.height;
   const currentLocation = useSelector(getCurrentLocation);
@@ -118,7 +120,7 @@ const NavigationGuidancePanel = ({ route }) => {
       addStyleToDocument(
         styleId,
         `.TomTomNavigation .mapboxgl-ctrl-top-right, .TomTomNavigation .mapboxgl-ctrl-top-left {
-           margin-top: ${guidancePanelHeight + 8}px;
+           margin-top: ${guidancePanelHeight + yOffset + 8}px;
          }
          .TomTomNavigation .mapboxgl-ctrl-bottom-right, .TomTomNavigation .mapboxgl-ctrl-bottom-left {
            margin-bottom: ${ETA_PANEL_HEIGHT}px;
diff --git a/src/functions/getManeuverIcon.js b/src/functions/getManeuverIcon.js
index c01bc69..f91359e 100644
--- a/src/functions/getManeuverIcon.js
+++ b/src/functions/getManeuverIcon.js
@@ -1,3 +1,4 @@
+import React from "react";
 import Maneuvers from "../constants/Maneuvers";
 import StraightIcon from "../icons/nip/StraightIcon";
 import KeepLeftIcon from "../icons/nip/KeepLeftIcon";
diff --git a/src/functions/tomtom2mapbox.js b/src/functions/tomtom2mapbox.js
index a0ad423..28b89da 100644
--- a/src/functions/tomtom2mapbox.js
+++ b/src/functions/tomtom2mapbox.js
@@ -6,6 +6,7 @@ const MANEUVERS = {
   ARRIVE: "arrive",
   ARRIVE_LEFT: "arrive",
   ARRIVE_RIGHT: "arrive",
+  ARRIVING: "continue",
   DEPART: "depart",
   STRAIGHT: "continue",
   KEEP_RIGHT: "right",
@@ -21,6 +22,8 @@ const MANEUVERS = {
   ENTER_FREEWAY: "continue",
   ENTER_HIGHWAY: "continue",
   TAKE_EXIT: "continue",
+  AHEAD_EXIT_LEFT: "continue",
+  AHEAD_EXIT_RIGHT: "continue",
   MOTORWAY_EXIT_LEFT: "bear left",
   MOTORWAY_EXIT_RIGHT: "bear right",
   TAKE_FERRY: "continue",
diff --git a/src/index.js b/src/index.js
index 46f738d..afd89c1 100644
--- a/src/index.js
+++ b/src/index.js
@@ -3,6 +3,8 @@ import { Provider as StoreProvider } from "react-redux";
 import { store } from "./app/store";
 import App from "./app/App";
 
+import "./css/TomTomNavigation.css";
+
 function Navigation(props) {
   return (
     <StoreProvider store={store}>
-- 
2.39.5 (Apple Git-154)

